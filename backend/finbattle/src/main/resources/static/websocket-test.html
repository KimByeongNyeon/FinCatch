<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FinBattle - Chat, Game & Quiz Test</title>
  <!-- SockJS와 StompJS 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #fff8f8;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" fill="none" stroke="%23ffcccc" stroke-width="1"><path d="M25,10 Q30,5 35,10 Q40,15 35,20 Q30,25 25,20 Q20,15 25,10 Z"/><circle cx="20" cy="40" r="3"/><circle cx="30" cy="40" r="3"/></svg>');
      background-size: 100px 100px;
    }

    .section {
      border: 2px solid #ffaaaa;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 10px;
      background-color: white;
      box-shadow: 0 3px 6px rgba(255, 170, 170, 0.2);
      position: relative;
    }

    .section::after {
      content: "🐾";
      position: absolute;
      bottom: 5px;
      right: 10px;
      opacity: 0.2;
      font-size: 20px;
    }

    .logBox {
      border: 1px solid #ffcccc;
      padding: 10px;
      height: 100px;
      overflow-y: auto;
      margin-top: 10px;
      background: #fff9f9;
      border-radius: 8px;
    }

    .statusBox {
      border: 1px solid #ffcccc;
      padding: 10px;
      height: 150px;
      overflow-y: auto;
      margin-top: 10px;
      background: #fff0f5;
      border-radius: 8px;
    }

    .userItem {
      margin: 5px 0;
      padding: 3px 8px;
      border-radius: 6px;
      background-color: #fff5f5;
    }

    .correct {
      color: green;
      font-weight: bold;
      margin-left: 10px;
    }

    button {
      padding: 5px 10px;
      margin: 0 5px;
      border-radius: 8px;
      cursor: pointer;
      background-color: #ff9999;
      border: none;
      color: white;
      transition: all 0.2s;
    }

    button:hover {
      background-color: #ff7777;
      transform: translateY(-2px);
    }

    input[type="text"],
    input[type="number"] {
      padding: 5px;
      border-radius: 6px;
      border: 1px solid #ffaaaa;
      background-color: #fffafa;
    }

    h1 {
      color: #ff6b6b;
      text-align: center;
    }

    h1::before, h1::after {
      content: "🐱";
      margin: 0 10px;
    }

    h2 {
      margin-top: 0;
      color: #ff6b6b;
      border-bottom: 2px dotted #ffdddd;
      padding-bottom: 5px;
    }

    .game-buttons {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #fff0f5;
      border-radius: 10px;
      border: 1px dashed #ffaaaa;
    }
  </style>
</head>
<body>
<h1>FinBattle - Chat, Game & Quiz Test</h1>

<!-- (1) 방 생성 영역 -->
<div class="section">
  <h2>방 생성</h2>
  <!-- userId (방 생성자 ID) -->
  <label>생성자 ID:</label>
  <input type="number" id="creatorUserId" placeholder="Enter Creator's User ID"/>

  <br/><br/>
  <label>방 제목:</label>
  <input type="text" id="roomTitle" placeholder="방 제목 입력"/>

  <br/><br/>
  <label>비밀번호:</label>
  <input type="text" id="roomPassword" placeholder="비밀번호(옵션)"/>

  <br/><br/>
  <label>최대 인원 수:</label>
  <input type="number" id="maxPlayer" placeholder="예) 4"/>

  <br/><br/>
  <!-- RoomType을 select로 변경 -->
  <label>방 유형:</label>
  <select id="roomType">
    <option value="ONE_ON_ONE">1대1 방</option>
    <option value="MULTI">다인전</option>
    <option value="AI_BATTLE">AI 배틀</option>
  </select>

  <br/><br/>
  <!-- QuizType을 select로 변경 -->
  <label>퀴즈 유형:</label>
  <select id="quizType">
    <option value="FIN_KNOWLEDGE">금융 지식</option>
    <option value="FIN_CRIME">금융 범죄</option>
    <option value="FIN_POLICY">금융 정책</option>
    <option value="FIN_PRODUCT">금융 상품</option>
    <option value="FIN_INVESTMENT">금융 투자</option>
  </select>

  <br/><br/>
  <button onclick="createRoom()">Create Room</button>
  <!-- 방 생성 결과를 표시할 영역 -->
  <div id="createRoomResult" class="logBox"></div>
</div>

<!-- (2) 방 접속 영역 -->
<div class="section">
  <h2>방 접속</h2>
  <label>Room ID: </label>
  <input type="text" id="roomId" placeholder="Enter Room ID"/>
  <label>User ID: </label>
  <input type="text" id="userId" placeholder="Enter Your ID"/>
  <button onclick="connect()">Connect</button>
</div>

<!-- (3) 접속 상태 영역 -->
<div class="section">
  <h2>Online Users</h2>
  <div id="userStatus" class="statusBox"></div>
</div>

<!-- [추가] 방 정보 조회 영역 -->
<div class="section">
  <h2>Room Info</h2>
  <button onclick="requestRoomInfo()">Get Room Info</button>
  <div id="roomInfo" class="logBox"></div>
</div>

<!-- [추가] 강퇴, 준비 버튼 영역 -->
<div class="section">
  <h2>Room Controls</h2>
  <!-- 다른 사용자를 강퇴할 수 있는 UI 예시 -->
  <label>Target User ID to kick: </label>
  <input type="text" id="kickUserId" placeholder="Enter target user ID"/>
  <button onclick="kickUser()">Kick User</button>
  <br/><br/>
  <!-- 자신을 ready 상태로 만들기 -->
  <button onclick="setReady()">I'm Ready</button>
  <div class="logBox" id="controlLog"></div>
</div>

<!-- (4) 채팅 영역 -->
<div class="section">
  <h2>Chat</h2>
  <label>Message: </label>
  <input type="text" id="chatMessage" placeholder="Type your chat message"/>
  <button onclick="sendChat()">Send Chat</button>
  <div id="chatLog" class="logBox"></div>
</div>

<!-- (5) 퀴즈 영역 -->
<div class="section">
  <h2>Quiz</h2>
  <button onclick="getQuiz()">Get Quiz Question</button>
  <button onclick="requestQuizHint()">Get Quiz Hint</button>
  <div id="quizQuestion" class="logBox"></div>
  <br/>
  <input type="text" id="quizAnswer" placeholder="Your Answer"/>
  <button onclick="submitQuizAnswer()">Submit Answer</button>
  <div id="quizResult" class="logBox"></div>
</div>

<!-- (6) 게임 정보 영역 -->
<div class="game-buttons">
  <button onclick="requestGameInfo()">Get Game Info</button>
  <button onclick="requestGameHint()">Request Game Hint</button>
</div>

<!-- 로그 표시용 (숨김) -->
<div id="gameInfo" style="display: none;"></div>
<div id="gameHint" style="display: none;"></div>

<script>
  let stompClient = null;
  let currentUserId = null;
  let users = {};

  document.addEventListener('DOMContentLoaded', function () {
    const quizAnswerInput = document.getElementById('quizAnswer');
    if (quizAnswerInput) {
      quizAnswerInput.addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
          submitQuizAnswer();
        }
      });
    }
  });

  // ========== (A) 방 생성 함수 (RoomCreateRequest -> RoomResponse) ==========
  function createRoom() {
    const creatorId = document.getElementById('creatorUserId').value;
    const title = document.getElementById('roomTitle').value;
    const password = document.getElementById('roomPassword').value;
    const maxPlayer = document.getElementById('maxPlayer').value;
    const roomType = document.getElementById('roomType').value;
    const quizType = document.getElementById('quizType').value;

    if (!creatorId || !title || !maxPlayer || !roomType) {
      alert("생성자 ID, 방 제목, 최대 인원 수, 방 유형은 필수 항목입니다.");
      return;
    }

    // RoomCreateRequest에 맞춰 JSON 데이터를 구성
    const payload = {
      userId: parseInt(creatorId, 10),
      roomTitle: title,
      password: password,
      maxPlayer: parseInt(maxPlayer, 10),
      roomType: roomType,
      quizType: quizType
    };

    // --- 새 백엔드: /api/room POST로 Room 생성 ---
    fetch('/api/room', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`서버 응답 에러: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      // data는 RoomResponse 형태 (roomId, roomTitle, status, roomType, quizType, maxPlayer, createdAt 등)
      const resultDiv = document.getElementById('createRoomResult');
      resultDiv.innerHTML = `
        <strong>방 생성 성공!</strong><br/>
        Room ID: ${data.roomId}<br/>
        Title: ${data.roomTitle}<br/>
        Status: ${data.status}<br/>
        RoomType: ${data.roomType}<br/>
        QuizType: ${data.quizType}<br/>
        MaxPlayer: ${data.maxPlayer}<br/>
        CreatedAt: ${data.createdAt}
      `;

      // 방 접속 섹션에 roomId, userId를 자동 설정
      document.getElementById('roomId').value = data.roomId;
      document.getElementById('userId').value = creatorId;

      // 방 생성이 완료되면 곧바로 connect() 호출
      connect();
    })
    .catch(error => {
      console.error("방 생성 실패:", error);
      alert("방 생성 중 오류가 발생했습니다. 콘솔을 확인하세요.");
    });
  }

  // ========== (B) 방 접속 함수 ==========
  function connect() {
    const socket = new SockJS('/ws/firechat');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
      console.log('Connected: ' + frame);

      const roomId = document.getElementById('roomId').value;
      currentUserId = document.getElementById('userId').value || 'Anonymous';

      // --- 새 백엔드: 방에 들어가기 ---
      stompClient.send(`/app/room/${roomId}/join/${currentUserId}`, {}, {});

      // --- 새 백엔드: 방 이벤트 구독 ---
      stompClient.subscribe(`/topic/room/${roomId}`, function (message) {
        const eventData = JSON.parse(message.body);
        console.log("Room Event Received:", eventData);

        // 이벤트 유형별 처리 (JOIN, LEAVE, KICK, READY 등)
        if (eventData.event === "KICK") {
          appendLog('controlLog',
              `User ${eventData.targetUserId} was kicked from room ${eventData.roomId}`);
        } else if (eventData.event === "KICK_FAIL") {
          appendLog('controlLog', `Kick failed: ${eventData.reason}`);
        } else if (eventData.event === "READY") {
          appendLog('controlLog', `User ${eventData.userId} is ready!`);
        } else if (eventData.event === "READY_FAIL") {
          appendLog('controlLog', `Ready failed: ${eventData.reason}`);
        } else if (eventData.event === "JOIN") {
          appendLog('controlLog', `User ${eventData.userId} joined the room`);
        } else if (eventData.event === "JOIN_FAIL") {
          appendLog('controlLog', `Join failed: ${eventData.reason}`);
        } else if (eventData.event === "LEAVE") {
          appendLog('controlLog', `User ${eventData.userId} left the room`);
        } else if (eventData.event === "DELETE") {
          appendLog('controlLog', `Room ${eventData.roomId} has been deleted`);
        } else if (eventData.event === "COUNT") {
          appendLog('controlLog', `User Count: ${eventData.userCount}`);
        }
      });

      // --- 새 백엔드: 방 정보 전용 구독 (/topic/room/{roomId}/info) ---
      stompClient.subscribe(`/topic/room/${roomId}/info`, function (message) {
        const roomData = JSON.parse(message.body);
        // (1) 에러 처리
        if (roomData.error) {
          document.getElementById('roomInfo').innerHTML =
              `<strong>Error:</strong> ${roomData.error}`;
          return;
        }
        // (2) 방 정보 표시
        displayRoomInfo(roomData);
      });

      // --- 채팅 구독 (/topic/chat/{roomId}) ---
      stompClient.subscribe(`/topic/chat/${roomId}`, function (msg) {
        const chatMessage = JSON.parse(msg.body);
        appendLog('chatLog', `${chatMessage.sender}: ${chatMessage.content}`);
      });

      // --- 퀴즈, 게임 쪽은 기존 경로 그대로 사용 (예시) ---
      stompClient.subscribe(`/topic/game/${roomId}-quiz`, function (msg) {
        const quizData = JSON.parse(msg.body);
        document.getElementById('quizQuestion').textContent =
            "Question: " + quizData.question;
      });

      stompClient.subscribe(`/topic/game/${roomId}-quizResult`, function (msg) {
        const resultData = JSON.parse(msg.body);
        document.getElementById('quizResult').textContent =
            `Result: ${resultData.result} (User: ${resultData.userId})`;
      });

      stompClient.subscribe(`/topic/game/${roomId}-quizHint`, function (msg) {
        const hintData = JSON.parse(msg.body);
        document.getElementById('quizQuestion').textContent +=
            "\nHint 1: " + hintData.hint1 + "\nHint 2: " + hintData.hint2;
      });
    });
  }

  // ========== (C) 채팅 전송 ==========
  function sendChat() {
    const roomId = document.getElementById('roomId').value;
    const content = document.getElementById('chatMessage').value;
    if (!roomId || !content || !currentUserId) {
      return;
    }
    const msgObj = {sender: currentUserId, content: content, roomId: roomId};
    // 새 백엔드: 채팅 전송 경로 예시 (변경 가능)
    stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify(msgObj));
    document.getElementById('chatMessage').value = '';
  }

  // ========== (D) 기타 기능 요청 ==========
  function requestGameInfo() {
    // (예시) 사용 중이면 유지, 그렇지 않다면 삭제 가능
    const roomId = document.getElementById('roomId').value;
    if (!roomId) {
      return;
    }
    stompClient.send(`/app/game/${roomId}-getInfo`, {}, {});
    alert("게임 정보 요청이 전송되었습니다.");
  }

  function requestGameHint() {
    // (예시) 사용 중이면 유지, 그렇지 않다면 삭제 가능
    const roomId = document.getElementById('roomId').value;
    if (!roomId) {
      return;
    }
    stompClient.send(`/app/game/${roomId}-hint`, {}, {});
    alert("게임 힌트 요청이 전송되었습니다.");
  }

  function getQuiz() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId) {
      return;
    }
    stompClient.send(`/app/game/${roomId}-getQuiz`, {}, {});
  }

  function requestQuizHint() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId) {
      return;
    }
    stompClient.send(`/app/game/${roomId}-quizHint`, {}, {});
  }

  function submitQuizAnswer() {
    const roomId = document.getElementById('roomId').value;
    const answer = document.getElementById('quizAnswer').value;
    if (!roomId || !answer || !currentUserId) {
      return;
    }
    const payload = {userAnswer: answer, userId: currentUserId};
    stompClient.send(`/app/game/${roomId}-checkAnswer`, {}, JSON.stringify(payload));
    document.getElementById('quizAnswer').value = '';
  }

  // ========== (E) UI 업데이트 함수들 ==========
  function appendLog(elementId, message) {
    const logDiv = document.getElementById(elementId);
    const newLine = document.createElement('div');
    newLine.textContent = message;
    logDiv.appendChild(newLine);
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // [추가] 방 정보 요청 함수
  function requestRoomInfo() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId) {
      return;
    }
    // 새 백엔드: 방 정보 요청
    stompClient.send(`/app/room/${roomId}/info`, {}, {});
  }

  // [추가] 방 정보 표시
  function displayRoomInfo(roomData) {
    const infoBox = document.getElementById('roomInfo');
    // 에러 존재 시 (이미 처리했지만 중복 처리 가능)
    if (roomData.error) {
      infoBox.innerHTML = `<strong>Error:</strong> ${roomData.error}`;
      return;
    }
    infoBox.innerHTML = `
      <div>Room ID: ${roomData.roomId}</div>
      <div>Max People: ${roomData.maxPeople}</div>
      <div>Status: ${roomData.status}</div>
      <div>Host: ${roomData.host ? roomData.host.memberId : 'None'}</div>
      <div>Members:</div>
    `;
    if (roomData.members && Array.isArray(roomData.members)) {
      roomData.members.forEach(m => {
        infoBox.innerHTML += `<div> - User: ${m.memberId}, State: ${m.status}</div>`;
      });
    } else {
      infoBox.innerHTML += "<div>(No members found)</div>";
    }
  }

  // [추가] 강퇴(kick)
  function kickUser() {
    const roomId = document.getElementById('roomId').value;
    const targetUserId = document.getElementById('kickUserId').value;
    if (!roomId || !targetUserId) {
      alert("Room ID와 Kick 대상 User ID가 필요합니다.");
      return;
    }
    stompClient.send(`/app/room/${roomId}/kick/${targetUserId}`, {}, {});
  }

  // [추가] 준비(ready)
  function setReady() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId || !currentUserId) {
      return;
    }
    stompClient.send(`/app/room/${roomId}/ready/${currentUserId}`, {}, {});
  }
</script>
</body>
</html>
