<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>FinBattle - Chat, Game & Quiz Test</title>
    <!-- SockJSÏôÄ StompJS ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #fff8f8;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" fill="none" stroke="%23ffcccc" stroke-width="1"><path d="M25,10 Q30,5 35,10 Q40,15 35,20 Q30,25 25,20 Q20,15 25,10 Z"/><circle cx="20" cy="40" r="3"/><circle cx="30" cy="40" r="3"/></svg>');
            background-size: 100px 100px;
            background-opacity: 0.2;
        }
        .section {
            border: 2px solid #ffaaaa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 3px 6px rgba(255, 170, 170, 0.2);
            position: relative;
        }
        .section::after {
            content: "üêæ";
            position: absolute;
            bottom: 5px;
            right: 10px;
            opacity: 0.2;
            font-size: 20px;
        }
        .logBox {
            border: 1px solid #ffcccc;
            padding: 10px;
            height: 100px;
            overflow-y: auto;
            margin-top: 10px;
            background: #fff9f9;
            border-radius: 8px;
        }
        .statusBox {
            border: 1px solid #ffcccc;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            margin-top: 10px;
            background: #fff0f5;
            border-radius: 8px;
        }
        .userItem {
            margin: 5px 0;
            padding: 3px 8px;
            border-radius: 6px;
            background-color: #fff5f5;
        }
        .correct {
            color: green;
            font-weight: bold;
            margin-left: 10px;
        }
        button {
            padding: 5px 10px;
            margin: 0 5px;
            border-radius: 8px;
            cursor: pointer;
            background-color: #ff9999;
            border: none;
            color: white;
            transition: all 0.2s;
        }
        button:hover {
            background-color: #ff7777;
            transform: translateY(-2px);
        }
        input[type="text"] {
            padding: 5px;
            border-radius: 6px;
            border: 1px solid #ffaaaa;
            background-color: #fffafa;
        }
        h1 {
            color: #ff6b6b;
            text-align: center;
        }
        h1::before, h1::after {
            content: "üê±";
            margin: 0 10px;
        }
        h2 {
            margin-top: 0;
            color: #ff6b6b;
            border-bottom: 2px dotted #ffdddd;
            padding-bottom: 5px;
        }
        .game-buttons {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            background-color: #fff0f5;
            border-radius: 10px;
            border: 1px dashed #ffaaaa;
        }
    </style>
</head>
<body>
<h1>FinBattle - Chat, Game & Quiz Test</h1>

<!-- Î∞© Ï†ëÏÜç ÏòÅÏó≠ -->
<div class="section">
    <h2>Î∞© Ï†ëÏÜç</h2>
    <label>Room ID: </label>
    <input type="text" id="roomId" placeholder="Enter Room ID" />
    <label>User ID: </label>
    <input type="text" id="userId" placeholder="Enter Your ID" />
    <button onclick="connect()">Connect</button>
</div>

<!-- Ï†ëÏÜç ÏÉÅÌÉú ÏòÅÏó≠ -->
<div class="section">
    <h2>Online Users</h2>
    <div id="userStatus" class="statusBox"></div>
</div>

<!-- Ï±ÑÌåÖ ÏòÅÏó≠ -->
<div class="section">
    <h2>Chat</h2>
    <label>Message: </label>
    <input type="text" id="chatMessage" placeholder="Type your chat message" />
    <button onclick="sendChat()">Send Chat</button>
    <div id="chatLog" class="logBox"></div>
</div>

<!-- ÌÄ¥Ï¶à ÏòÅÏó≠ -->
<div class="section">
    <h2>Quiz</h2>
    <button onclick="getQuiz()">Get Quiz Question</button>
    <button onclick="requestQuizHint()">Get Quiz Hint</button>
    <div id="quizQuestion" class="logBox"></div>
    <br/>
    <input type="text" id="quizAnswer" placeholder="Your Answer" />
    <button onclick="submitQuizAnswer()">Submit Answer</button>
    <div id="quizResult" class="logBox"></div>
</div>

<!-- Í≤åÏûÑ Ï†ïÎ≥¥ ÏòÅÏó≠ - Î≤ÑÌäºÎßå ÎÇ®ÍπÄ -->
<div class="game-buttons">
    <button onclick="requestGameInfo()">Get Game Info</button>
    <button onclick="requestGameHint()">Request Game Hint</button>
</div>

<!-- Î°úÍ∑∏ ÌëúÏãúÎ•º ÏúÑÌïú Ïà®Í≤®ÏßÑ div -->
<div id="gameInfo" style="display: none;"></div>
<div id="gameHint" style="display: none;"></div>

<script>
    let stompClient = null;
    let currentUserId = null;
    let users = {};

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÌÄ¥Ï¶à ÎãµÎ≥Ä ÏûÖÎ†•ÎûÄÏóê ÏóîÌÑ∞ ÌÇ§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    document.addEventListener('DOMContentLoaded', function() {
        const quizAnswerInput = document.getElementById('quizAnswer');
        if (quizAnswerInput) {
            quizAnswerInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    submitQuizAnswer();
                }
            });
        }
    });

    function connect() {
        const socket = new SockJS('/ws/firechat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            const roomId = document.getElementById('roomId').value;
            currentUserId = document.getElementById('userId').value || 'Anonymous';

            stompClient.send(`/app/game/${roomId}-connect`, {}, JSON.stringify({ userId: currentUserId }));

            stompClient.subscribe(`/topic/game/${roomId}-userStatus`, function(message) {
                const userList = JSON.parse(message.body);
                users = {};
                userList.forEach(user => {
                    users[user.userId] = { id: user.userId, life: user.life };
                });
                updateUserStatus();
            });

            stompClient.subscribe(`/topic/chat/${roomId}`, function(message) {
                const chatMessage = JSON.parse(message.body);
                appendLog('chatLog', `${chatMessage.sender}: ${chatMessage.content}`);
            });

            stompClient.subscribe(`/topic/game/${roomId}-getInfo`, function(info) {
                const gameData = JSON.parse(info.body);
                displayGameInfo(gameData);
            });

            stompClient.subscribe(`/topic/game/${roomId}-hint`, function(hint) {
                displayGameHint(hint.body);
            });

            stompClient.subscribe(`/topic/game/${roomId}-quiz`, function(message) {
                const quizData = JSON.parse(message.body);
                document.getElementById('quizQuestion').textContent = "Question: " + quizData.question;
            });

            stompClient.subscribe(`/topic/game/${roomId}-quizResult`, function(message) {
                const resultData = JSON.parse(message.body);
                document.getElementById('quizResult').textContent = `Result: ${resultData.result} (User: ${resultData.userId})`;
            });

            stompClient.subscribe(`/topic/game/${roomId}-quizHint`, function(message) {
                const hintData = JSON.parse(message.body);
                document.getElementById('quizQuestion').textContent +=
                    "\nHint 1: " + hintData.hint1 + "\nHint 2: " + hintData.hint2;
            });
        });
    }

    function sendChat() {
        const roomId = document.getElementById('roomId').value;
        const content = document.getElementById('chatMessage').value;
        if (!roomId || !content || !currentUserId) return;
        const msgObj = { sender: currentUserId, content: content, roomId: roomId };
        stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify(msgObj));
        document.getElementById('chatMessage').value = '';
    }

    function requestGameInfo() {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) return;
        stompClient.send(`/app/game/${roomId}-getInfo`, {}, {});
        alert("Í≤åÏûÑ Ï†ïÎ≥¥ ÏöîÏ≤≠Ïù¥ Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§.");
    }

    function requestGameHint() {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) return;
        stompClient.send(`/app/game/${roomId}-hint`, {}, {});
        alert("Í≤åÏûÑ ÌûåÌä∏ ÏöîÏ≤≠Ïù¥ Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§.");
    }

    function getQuiz() {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) return;
        stompClient.send(`/app/game/${roomId}-getQuiz`, {}, {});
    }

    function requestQuizHint() {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) return;
        stompClient.send(`/app/game/${roomId}-quizHint`, {}, {});
    }

    function submitQuizAnswer() {
        const roomId = document.getElementById('roomId').value;
        const answer = document.getElementById('quizAnswer').value;
        if (!roomId || !answer || !currentUserId) return;
        const payload = { userAnswer: answer, userId: currentUserId };
        stompClient.send(`/app/game/${roomId}-checkAnswer`, {}, JSON.stringify(payload));
        document.getElementById('quizAnswer').value = '';
    }

    function updateUserStatus() {
        const statusDiv = document.getElementById('userStatus');
        statusDiv.innerHTML = '';
        for (const userId in users) {
            const user = users[userId];
            const userDiv = document.createElement('div');
            userDiv.className = 'userItem';
            userDiv.textContent = "üò∫ " + user.id + " - Life: " + user.life;
            if (user.life <= 0) {
                const defeatSpan = document.createElement('span');
                defeatSpan.className = 'correct';
                defeatSpan.textContent = " (Defeated)";
                userDiv.appendChild(defeatSpan);
            }
            statusDiv.appendChild(userDiv);
        }
    }

    function appendLog(elementId, message) {
        const logDiv = document.getElementById(elementId);
        const newLine = document.createElement('div');
        newLine.textContent = message;
        logDiv.appendChild(newLine);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function displayGameInfo(gameData) {
        console.log("Í≤åÏûÑ Ï†ïÎ≥¥:", gameData);
        document.getElementById('gameInfo').innerHTML = "Status: " + gameData.status + "<br/>Score: " + gameData.score;
        alert("Í≤åÏûÑ ÏÉÅÌÉú: " + gameData.status + "\nÏä§ÏΩîÏñ¥: " + gameData.score);
    }

    function displayGameHint(hint) {
        console.log("Í≤åÏûÑ ÌûåÌä∏:", hint);
        document.getElementById('gameHint').textContent = "Game Hint: " + hint;
        alert("Í≤åÏûÑ ÌûåÌä∏: " + hint);
    }
</script>
</body>
</html>