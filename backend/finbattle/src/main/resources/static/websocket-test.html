<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>FinBattle - Chat, Game & Quiz Test</title>
    <!-- SockJS와 StompJS 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .logBox {
            border: 1px solid #aaa;
            padding: 10px;
            height: 100px;
            overflow-y: auto;
            margin-top: 10px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .statusBox {
            border: 1px solid #aaa;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            margin-top: 10px;
            background: #f0f8ff;
            border-radius: 5px;
        }
        .userItem { margin: 5px 0; }
        .correct { color: green; font-weight: bold; margin-left: 10px; }
        button { padding: 5px 10px; margin: 0 5px; border-radius: 3px; cursor: pointer; }
        input[type="text"] { padding: 5px; border-radius: 3px; border: 1px solid #ccc; }
        h2 { margin-top: 0; }
    </style>
</head>
<body>
<h1>FinBattle - Chat, Game & Quiz Test</h1>

<!-- 방 접속 영역 -->
<div class="section">
    <label>Room ID: </label>
    <input type="text" id="roomId" placeholder="Enter Room ID" />
    <label>User ID: </label>
    <input type="text" id="userId" placeholder="Enter Your ID" />
    <button onclick="connect()">Connect</button>
</div>

<!-- 접속 상태 영역 -->
<div class="section">
    <h2>Online Users</h2>
    <div id="userStatus" class="statusBox"></div>
</div>

<!-- 채팅 영역 -->
<div class="section">
    <h2>Chat</h2>
    <label>Message: </label>
    <input type="text" id="chatMessage" placeholder="Type your chat message" />
    <button onclick="sendChat()">Send Chat</button>
    <div id="chatLog" class="logBox"></div>
</div>

<!-- 게임 정보 영역 -->
<div class="section">
    <h2>Game</h2>
    <button onclick="requestGameInfo()">Get Game Info</button>
    <button onclick="requestGameHint()">Request Game Hint</button>
    <div id="gameInfo" class="logBox"></div>
    <div id="gameHint" class="logBox"></div>
</div>

<!-- 퀴즈 영역 -->
<div class="section">
    <h2>Quiz</h2>
    <button onclick="getQuiz()">Get Quiz Question</button>
    <button onclick="requestQuizHint()">Get Quiz Hint</button>
    <div id="quizQuestion" class="logBox"></div>
    <br/>
    <input type="text" id="quizAnswer" placeholder="Your Answer" />
    <button onclick="submitQuizAnswer()">Submit Answer</button>
    <div id="quizResult" class="logBox"></div>
</div>

<script>
    let stompClient = null;
    let currentUserId = null;
    let users = {}; // 접속한 사용자 상태를 저장하는 객체

    // WebSocket 연결 및 구독 설정
    function connect() {
        const socket = new SockJS('/ws/firechat');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            const roomId = document.getElementById('roomId').value;
            currentUserId = document.getElementById('userId').value || 'Anonymous';

            // 사용자 접속 메시지 전송
            stompClient.send(`/app/game/${roomId}-connect`, {}, JSON.stringify({ userId: currentUserId }));

            // 사용자 상태 구독
            stompClient.subscribe(`/topic/game/${roomId}-userStatus`, function(message) {
                const userList = JSON.parse(message.body);
                users = {};
                userList.forEach(user => {
                    users[user.userId] = { id: user.userId, correct: user.correct };
                });
                updateUserStatus();
            });

            // 채팅 메시지 구독
            stompClient.subscribe(`/topic/chat/${roomId}`, function(message) {
                const chatMessage = JSON.parse(message.body);
                appendLog('chatLog', `${chatMessage.sender}: ${chatMessage.content}`);
            });

            // 게임 정보 구독
            stompClient.subscribe(`/topic/game/${roomId}-getInfo`, function(info) {
                const gameData = JSON.parse(info.body);
                displayGameInfo(gameData);
            });

            // 게임 힌트 구독
            stompClient.subscribe(`/topic/game/${roomId}-hint`, function(hint) {
                displayGameHint(hint.body);
            });

            // 퀴즈 문제 구독
            stompClient.subscribe(`/topic/game/${roomId}-quiz`, function(message) {
                const quizData = JSON.parse(message.body);
                document.getElementById('quizQuestion').textContent = "Question: " + quizData.question;
            });

            // 퀴즈 정답 결과 구독
            stompClient.subscribe(`/topic/game/${roomId}-quizResult`, function(message) {
                const resultData = JSON.parse(message.body);
                document.getElementById('quizResult').textContent = `Result: ${resultData.result} (User: ${resultData.userId})`;
                // 상태는 userStatus 구독에서 업데이트되므로 여기서는 결과만 표시
            });

            // 퀴즈 힌트 구독
            stompClient.subscribe(`/topic/game/${roomId}-quizHint`, function(message) {
                const hintData = JSON.parse(message.body);
                document.getElementById('quizQuestion').textContent +=
                    "\nHint 1: " + hintData.hint1 + "\nHint 2: " + hintData.hint2;
            });
        });
    }

    // 채팅 메시지 전송
    function sendChat() {
        const roomId = document.getElementById('roomId').value;
        const content = document.getElementById('chatMessage').value;
        if (!roomId || !content || !currentUserId) return;
        const msgObj = {
            sender: currentUserId,
            content: content,
            roomId: roomId
        };
        stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify(msgObj));
        document.getElementById('chatMessage').value = '';
    }

    // 게임 정보 요청
    function requestGameInfo() {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) return;
        stompClient.send(`/app/game/${roomId}-getInfo`, {}, {});
    }

    // 게임 힌트 요청
    function requestGameHint() {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) return;
        stompClient.send(`/app/game/${roomId}-hint`, {}, {});
    }

    // 퀴즈 문제 요청
    function getQuiz() {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) return;
        stompClient.send(`/app/game/${roomId}-getQuiz`, {}, {});
    }

    // 퀴즈 힌트 요청
    function requestQuizHint() {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) return;
        stompClient.send(`/app/game/${roomId}-quizHint`, {}, {});
    }

    // 퀴즈 정답 제출
    function submitQuizAnswer() {
        const roomId = document.getElementById('roomId').value;
        const answer = document.getElementById('quizAnswer').value;
        if (!roomId || !answer || !currentUserId) return;
        const payload = { userAnswer: answer, userId: currentUserId };
        stompClient.send(`/app/game/${roomId}-checkAnswer`, {}, JSON.stringify(payload));
        document.getElementById('quizAnswer').value = '';
    }

    // 사용자 상태 업데이트
    function updateUserStatus() {
        const statusDiv = document.getElementById('userStatus');
        statusDiv.innerHTML = '';
        for (const userId in users) {
            const user = users[userId];
            const userDiv = document.createElement('div');
            userDiv.className = 'userItem';
            userDiv.textContent = user.id;
            if (user.correct) {
                const correctSpan = document.createElement('span');
                correctSpan.className = 'correct';
                correctSpan.textContent = 'O';
                userDiv.appendChild(correctSpan);
            }
            statusDiv.appendChild(userDiv);
        }
    }

    // 로그 영역에 메시지 추가 (채팅 등)
    function appendLog(elementId, message) {
        const logDiv = document.getElementById(elementId);
        const newLine = document.createElement('div');
        newLine.textContent = message;
        logDiv.appendChild(newLine);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // 게임 정보 표시
    function displayGameInfo(gameData) {
        const gameInfoDiv = document.getElementById('gameInfo');
        gameInfoDiv.innerHTML = "Status: " + gameData.status + "<br/>Score: " + gameData.score;
    }

    // 게임 힌트 표시
    function displayGameHint(hint) {
        const gameHintDiv = document.getElementById('gameHint');
        gameHintDiv.textContent = "Game Hint: " + hint;
    }
</script>
</body>
</html>